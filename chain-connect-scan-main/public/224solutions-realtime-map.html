<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>224Solutions Map Web ‚Äì Suivi temps r√©el WebSocket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.18.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.18.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .marker { 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .marker:hover { transform: scale(1.2); }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .status-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }
        
        .status-dot.connected { background: #10b981; }
        
        .service-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .filter-btn {
            background: #f3f4f6;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .filter-btn.active { background: #3b82f6; color: white; }
        .filter-btn:hover { background: #e5e7eb; }
        .filter-btn.active:hover { background: #2563eb; }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .btn:hover { background: #2563eb; }
        .btn.secondary { background: #6b7280; }
        .btn.secondary:hover { background: #4b5563; }
        
        @media (max-width: 768px) {
            .status-panel, .controls {
                left: 5px;
                right: 5px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Status Panel -->
    <div class="status-panel">
        <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">Connexion...</span>
        </div>
        
        <div>
            <strong>Services actifs:</strong> <span id="activeCount">0</span>
        </div>
        
        <div class="service-filters">
            <button class="filter-btn active" onclick="filterServices('all')">Tous</button>
            <button class="filter-btn" onclick="filterServices('livreur')">üèçÔ∏è Livreurs</button>
            <button class="filter-btn" onclick="filterServices('taxi')">üöï Taxis</button>
            <button class="filter-btn" onclick="filterServices('transitaire')">üè≠ Transitaires</button>
        </div>
        
        <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
            Derni√®re MAJ: <span id="lastUpdate">-</span>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
        <button class="btn" onclick="requestCurrentLocation()">üìç Ma position</button>
        <button class="btn secondary" onclick="toggleTracking()">üîÑ Suivi auto</button>
        <button class="btn secondary" onclick="calculateRouteToNearest()">üó∫Ô∏è Route</button>
        <span style="margin-left: 10px; font-size: 12px; color: #6b7280;">
            WebSocket: <span id="wsStatus">D√©connect√©</span>
        </span>
    </div>

    <script>
        // Configuration 224Solutions
        const MAPBOX_TOKEN = 'ACCESS_TOKEN_WEB'; // Remplace par ton token Web
        const WEBSOCKET_URL = 'wss://vuqauasbhkfozehfmkjt.supabase.co/functions/v1/realtime-tracking';
        
        // √âtat global
        let map;
        let websocket;
        let markers = {};
        let services = [];
        let currentFilter = 'all';
        let autoTracking = false;
        let userLocation = null;
        let currentRoute = null;

        // Configuration des couleurs 224Solutions
        const serviceConfig = {
            livreur: { color: '#3b82f6', emoji: 'üèçÔ∏è', label: 'LIVREUR' },
            taxi: { color: '#fbbf24', emoji: 'üöï', label: 'TAXI MOTO' },
            transitaire: { color: '#10b981', emoji: 'üè≠', label: 'TRANSITAIRE' },
            client: { color: '#10b981', emoji: 'üë§', label: 'CLIENT' },
            vendeur: { color: '#10b981', emoji: 'üè™', label: 'VENDEUR' }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            connectWebSocket();
            setupLocationTracking();
        });

        function initializeMap() {
            mapboxgl.accessToken = MAPBOX_TOKEN;
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [13.234, 9.537], // Conakry, Guin√©e
                zoom: 12
            });

            map.on('load', function() {
                console.log('‚úÖ Carte 224Solutions charg√©e');
                
                // Ajouter contr√¥les de navigation
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                
                // Ajouter contr√¥le de g√©olocalisation
                map.addControl(
                    new mapboxgl.GeolocateControl({
                        positionOptions: { enableHighAccuracy: true },
                        trackUserLocation: true,
                        showUserHeading: true
                    }),
                    'top-right'
                );
            });
        }

        function connectWebSocket() {
            try {
                websocket = new WebSocket(WEBSOCKET_URL);
                
                websocket.onopen = function(event) {
                    console.log('üîå WebSocket connect√©');
                    updateConnectionStatus(true);
                    
                    // S'abonner aux services
                    websocket.send(JSON.stringify({
                        type: 'subscribe_to_services',
                        services: ['courier', 'taxi_moto', 'freight_forwarder', 'seller', 'client']
                    }));
                };

                websocket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };

                websocket.onclose = function(event) {
                    console.log('üîå WebSocket d√©connect√©');
                    updateConnectionStatus(false);
                    
                    // Tentative de reconnexion apr√®s 5 secondes
                    setTimeout(connectWebSocket, 5000);
                };

                websocket.onerror = function(error) {
                    console.error('‚ùå Erreur WebSocket:', error);
                    updateConnectionStatus(false);
                };

            } catch (error) {
                console.error('‚ùå Impossible de se connecter au WebSocket:', error);
                updateConnectionStatus(false);
            }
        }

        function handleWebSocketMessage(message) {
            console.log('üì® Message re√ßu:', message.type);
            
            switch (message.type) {
                case 'connection_established':
                    console.log('‚úÖ Connexion √©tablie:', message.connectionId);
                    break;
                    
                case 'services_update':
                case 'subscription_update':
                    services = message.data;
                    updateServiceMarkers();
                    updateUI();
                    break;
                    
                case 'location_updated':
                    updateSingleService(message.data);
                    break;
                    
                case 'route_calculated':
                    displayRoute(message.data);
                    break;
                    
                case 'pong':
                    console.log('üèì Pong re√ßu');
                    break;
                    
                default:
                    console.log('‚ùì Type de message non g√©r√©:', message.type);
            }
            
            updateLastUpdateTime();
        }

        function updateServiceMarkers() {
            // Supprimer les anciens marqueurs
            Object.values(markers).forEach(marker => marker.remove());
            markers = {};

            // Ajouter les nouveaux marqueurs filtr√©s
            services.forEach(service => {
                if (currentFilter === 'all' || currentFilter === service.type) {
                    createServiceMarker(service);
                }
            });

            console.log(`üìç ${Object.keys(markers).length} marqueurs affich√©s`);
        }

        function createServiceMarker(service) {
            const config = serviceConfig[service.type] || serviceConfig.client;
            
            // Cr√©er l'√©l√©ment du marqueur
            const el = document.createElement('div');
            el.className = 'marker';
            el.style.backgroundColor = config.color;
            
            // Animation pour services r√©cents (moins de 2 minutes)
            const age = Date.now() - service.timestamp;
            if (age < 120000) {
                el.classList.add('pulse');
            }

            // Cr√©er le marqueur Mapbox
            const marker = new mapboxgl.Marker(el)
                .setLngLat([service.lng, service.lat])
                .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
                    <div style="padding: 10px; max-width: 200px;">
                        <h4 style="margin: 0 0 8px 0; color: ${config.color};">
                            ${config.emoji} ${config.label}
                        </h4>
                        <p style="margin: 0 0 4px 0;"><strong>${service.name}</strong></p>
                        <p style="margin: 0 0 4px 0;">Statut: <span style="color: ${config.color};">${service.status}</span></p>
                        <p style="margin: 0; font-size: 12px; color: #666;">
                            Position: ${service.lat.toFixed(4)}, ${service.lng.toFixed(4)}
                        </p>
                        <p style="margin: 4px 0 0 0; font-size: 11px; color: #999;">
                            MAJ: ${new Date(service.timestamp).toLocaleTimeString()}
                        </p>
                        <div style="margin-top: 8px;">
                            <button onclick="contactService('${service.id}')" style="background: ${config.color}; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                üìû Contacter
                            </button>
                            <button onclick="navigateToService('${service.id}')" style="background: #6b7280; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                üó∫Ô∏è Naviguer
                            </button>
                        </div>
                    </div>
                `))
                .addTo(map);

            markers[service.id] = marker;
        }

        function updateSingleService(serviceData) {
            // Trouver et mettre √† jour le service dans la liste
            const index = services.findIndex(s => s.id === serviceData.id);
            if (index !== -1) {
                services[index] = { ...services[index], ...serviceData };
            } else {
                services.push(serviceData);
            }
            
            // Mettre √† jour le marqueur si visible
            if (currentFilter === 'all' || currentFilter === serviceData.type) {
                if (markers[serviceData.id]) {
                    markers[serviceData.id].setLngLat([serviceData.lng, serviceData.lat]);
                } else {
                    createServiceMarker(serviceData);
                }
            }
            
            updateUI();
        }

        function filterServices(type) {
            currentFilter = type;
            
            // Mettre √† jour l'UI des boutons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateServiceMarkers();
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            const wsStatus = document.getElementById('wsStatus');
            
            if (connected) {
                dot.classList.add('connected');
                status.textContent = 'Connect√©';
                wsStatus.textContent = 'Connect√©';
            } else {
                dot.classList.remove('connected');
                status.textContent = 'D√©connect√©';
                wsStatus.textContent = 'D√©connect√©';
            }
        }

        function updateUI() {
            document.getElementById('activeCount').textContent = services.length;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function setupLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = [position.coords.longitude, position.coords.latitude];
                    
                    // Ajouter marqueur utilisateur
                    new mapboxgl.Marker({ color: '#ef4444' })
                        .setLngLat(userLocation)
                        .setPopup(new mapboxgl.Popup().setHTML('<p><strong>Votre position</strong></p>'))
                        .addTo(map);
                });
            }
        }

        function requestCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    map.flyTo({ center: coords, zoom: 15 });
                });
            }
        }

        function toggleTracking() {
            autoTracking = !autoTracking;
            const btn = event.target;
            
            if (autoTracking) {
                btn.textContent = '‚è∏Ô∏è Pause suivi';
                btn.style.background = '#ef4444';
                
                // Envoyer ping toutes les 30 secondes
                setInterval(() => {
                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                        websocket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            } else {
                btn.textContent = 'üîÑ Suivi auto';
                btn.style.background = '#6b7280';
            }
        }

        function calculateRouteToNearest() {
            if (!userLocation || services.length === 0) {
                alert('Position utilisateur ou services non disponibles');
                return;
            }
            
            // Trouver le service le plus proche
            let nearest = null;
            let minDistance = Infinity;
            
            services.forEach(service => {
                const distance = calculateDistance(userLocation, [service.lng, service.lat]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = service;
                }
            });
            
            if (nearest && websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'get_route',
                    data: {
                        start: userLocation,
                        end: [nearest.lng, nearest.lat]
                    }
                }));
            }
        }

        function displayRoute(routeData) {
            // Supprimer la route pr√©c√©dente
            if (currentRoute && map.getSource('route')) {
                map.removeLayer('route');
                map.removeSource('route');
            }
            
            // Ajouter la nouvelle route
            map.addSource('route', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    properties: {},
                    geometry: routeData.geometry
                }
            });

            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#3b82f6',
                    'line-width': 6,
                    'line-opacity': 0.8
                }
            });
            
            currentRoute = routeData;
            
            // Afficher info route
            alert(`Route calcul√©e:\nDistance: ${(routeData.distance / 1000).toFixed(1)} km\nDur√©e: ${Math.round(routeData.duration / 60)} min`);
        }

        function contactService(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (service) {
                alert(`üìû Contacter ${service.name}\nType: ${serviceConfig[service.type].label}`);
                // Ici, int√©grer l'API de communication 224Solutions
            }
        }

        function navigateToService(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (service && userLocation) {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'get_route',
                        data: {
                            start: userLocation,
                            end: [service.lng, service.lat]
                        }
                    }));
                }
            }
        }

        function calculateDistance(coord1, coord2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
            const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Auto-reconnexion WebSocket
        setInterval(() => {
            if (websocket && websocket.readyState === WebSocket.CLOSED) {
                console.log('üîÑ Tentative de reconnexion WebSocket...');
                connectWebSocket();
            }
        }, 10000);

        console.log('üöÄ 224Solutions Real-time Map initialis√©');
    </script>
</body>
</html>