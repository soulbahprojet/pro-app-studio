<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>224Solutions Map Web - Suivi en Temps R√©el</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.18.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.18.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
        }
        
        .service-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .service-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .service-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .btn:hover { background: #2563eb; }
        .btn.active { background: #10b981; }
        
        @media (max-width: 768px) {
            .map-overlay, .controls {
                left: 5px;
                right: 5px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- L√©gende des services -->
    <div class="map-overlay">
        <h3 style="margin: 0 0 10px 0; color: #1f2937;">üìç Services 224Solutions</h3>
        <div class="service-legend">
            <div class="service-item">
                <div class="service-color" style="background-color: #3b82f6;"></div>
                <span><strong>LIVREUR</strong> - Service de livraison</span>
            </div>
            <div class="service-item">
                <div class="service-color" style="background-color: #fbbf24;"></div>
                <span><strong>TAXI MOTO</strong> - Transport de personnes</span>
            </div>
            <div class="service-item">
                <div class="service-color" style="background-color: #10b981;"></div>
                <span><strong>TRANSITAIRE</strong> - Logistique internationale</span>
            </div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
            Mise √† jour en temps r√©el
        </div>
    </div>
    
    <!-- Contr√¥les -->
    <div class="controls">
        <button class="btn active" onclick="toggleService('all')">Tous les services</button>
        <button class="btn" onclick="toggleService('livreur')">Livreurs</button>
        <button class="btn" onclick="toggleService('taxi')">Taxi Moto</button>
        <button class="btn" onclick="toggleService('transitaire')">Transitaires</button>
        <button class="btn" onclick="refreshData()">üîÑ Actualiser</button>
    </div>

    <script>
        // Configuration 224Solutions
        mapboxgl.accessToken = 'ACCESS_TOKEN_WEB'; // Token Web s√©curis√©

        // Initialisation de la carte centr√©e sur Conakry, Guin√©e
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [13.234, 9.537], // Conakry
            zoom: 12
        });

        // √âtat des services
        let currentFilter = 'all';
        let markers = [];
        let services = [
            { id: '1', type: 'livreur', lat: 9.540, lng: 13.240, name: 'Livreur Alpha', status: 'en_mission' },
            { id: '2', type: 'livreur', lat: 9.545, lng: 13.245, name: 'Livreur Beta', status: 'disponible' },
            { id: '3', type: 'taxi', lat: 9.530, lng: 13.230, name: 'Taxi Moto Charlie', status: 'en_course' },
            { id: '4', type: 'taxi', lat: 9.528, lng: 13.235, name: 'Taxi Moto Delta', status: 'disponible' },
            { id: '5', type: 'transitaire', lat: 9.538, lng: 13.235, name: 'Entrep√¥t Central', status: 'actif' },
            { id: '6', type: 'transitaire', lat: 9.542, lng: 13.238, name: 'Entrep√¥t Nord', status: 'actif' }
        ];

        // Configuration des couleurs selon la sp√©cification 224Solutions
        const serviceConfig = {
            livreur: { color: '#3b82f6', emoji: 'üèçÔ∏è', label: 'LIVREUR' },
            taxi: { color: '#fbbf24', emoji: 'üöï', label: 'TAXI MOTO' },
            transitaire: { color: '#10b981', emoji: 'üè≠', label: 'TRANSITAIRE' }
        };

        // Initialisation apr√®s chargement de la carte
        map.on('load', function() {
            console.log('‚úÖ Carte 224Solutions charg√©e');
            addServiceMarkers();
            
            // Simulation de mise √† jour en temps r√©el
            setInterval(updateServicePositions, 15000); // Toutes les 15 secondes
        });

        // Ajouter les marqueurs des services
        function addServiceMarkers() {
            // Supprimer les anciens marqueurs
            clearMarkers();

            services.forEach(service => {
                if (currentFilter === 'all' || currentFilter === service.type) {
                    const config = serviceConfig[service.type];
                    
                    // Cr√©er l'√©l√©ment DOM du marqueur
                    const el = document.createElement('div');
                    el.className = 'marker';
                    el.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background-color: ${config.color};
                        border: 2px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        transition: transform 0.2s ease;
                    `;
                    
                    // Animation hover
                    el.addEventListener('mouseenter', () => el.style.transform = 'scale(1.2)');
                    el.addEventListener('mouseleave', () => el.style.transform = 'scale(1)');

                    // Cr√©er le marqueur Mapbox
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([service.lng, service.lat])
                        .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
                            <div style="padding: 10px; max-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: ${config.color};">
                                    ${config.emoji} ${config.label}
                                </h4>
                                <p style="margin: 0 0 4px 0;"><strong>${service.name}</strong></p>
                                <p style="margin: 0 0 4px 0;">Statut: <span style="color: ${getStatusColor(service.status)};">${service.status}</span></p>
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    Position: ${service.lat.toFixed(4)}, ${service.lng.toFixed(4)}
                                </p>
                                <div style="margin-top: 8px;">
                                    <button onclick="contactService('${service.id}')" style="background: ${config.color}; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                        üìû Contacter
                                    </button>
                                </div>
                            </div>
                        `))
                        .addTo(map);

                    markers.push(marker);
                }
            });

            console.log(`üìç ${markers.length} marqueurs ajout√©s pour: ${currentFilter}`);
        }

        // Supprimer tous les marqueurs
        function clearMarkers() {
            markers.forEach(marker => marker.remove());
            markers = [];
        }

        // Filtrer les services
        function toggleService(type) {
            currentFilter = type;
            
            // Mettre √† jour l'UI des boutons
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Recharger les marqueurs
            addServiceMarkers();
        }

        // Actualiser les donn√©es
        function refreshData() {
            console.log('üîÑ Actualisation des donn√©es...');
            
            // Simuler de nouvelles donn√©es depuis l'API 224Solutions
            services.forEach(service => {
                // Petite variation de position pour simuler le mouvement
                service.lat += (Math.random() - 0.5) * 0.002;
                service.lng += (Math.random() - 0.5) * 0.002;
            });
            
            addServiceMarkers();
        }

        // Mettre √† jour les positions automatiquement
        function updateServicePositions() {
            console.log('üîÑ Mise √† jour automatique des positions...');
            
            // Simuler les mises √† jour depuis le backend
            services.forEach(service => {
                if (Math.random() > 0.7) { // 30% de chance de bouger
                    service.lat += (Math.random() - 0.5) * 0.001;
                    service.lng += (Math.random() - 0.5) * 0.001;
                }
            });
            
            addServiceMarkers();
        }

        // Contacter un service
        function contactService(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (service) {
                alert(`üìû Appel vers ${service.name}\nType: ${serviceConfig[service.type].label}\nStatut: ${service.status}`);
                // Ici, int√©grer l'API de communication de 224Solutions
            }
        }

        // Couleur du statut
        function getStatusColor(status) {
            const colors = {
                'disponible': '#10b981',
                'en_mission': '#3b82f6',
                'en_course': '#f59e0b',
                'actif': '#10b981',
                'hors_ligne': '#6b7280'
            };
            return colors[status] || '#6b7280';
        }

        // Gestion de la g√©olocalisation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const userLocation = [position.coords.longitude, position.coords.latitude];
                
                // Ajouter marqueur utilisateur
                new mapboxgl.Marker({ color: '#ef4444' })
                    .setLngLat(userLocation)
                    .setPopup(new mapboxgl.Popup().setHTML('<p><strong>Votre position</strong></p>'))
                    .addTo(map);
                
                console.log('üìç Position utilisateur ajout√©e');
            });
        }

        // Responsive: adapter la vue sur mobile
        function handleResize() {
            if (window.innerWidth < 768) {
                map.setZoom(11);
            } else {
                map.setZoom(12);
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize(); // Appel initial

        console.log('üöÄ Application 224Solutions Map initialis√©e');
    </script>
</body>
</html>